import{registerComponent as h}from"/1/bundle/esm/l/en-US/bi/0/module/mi/lwc%2Fv%2F8_12_7/s/sha256-A4k_e_1rs5Y4edfd78wU8iL0ESRybIXT4kbpYdnL__Y/bundle_lwc.js";import{load as u}from"/1/bundle/esm/l/en-US/bi/0/module/mi/lwr%2FesmLoader%2Fv%2F0_16_11/s/sha256-XZ3-fTIQeMpr-t515p72MK4vr6gSnXsH3O_YELtRaFw/bundle_lwr_esmLoader.js";var _=void 0,f=void 0;class m{constructor(){this.clientId=this.getEnvironmentVariable("SF_CLIENT_ID"),this.clientSecret=this.getEnvironmentVariable("SF_CLIENT_SECRET"),this.redirectUri=this.getEnvironmentVariable("SF_REDIRECT_URI"),this.loginUrl=this.getEnvironmentVariable("SF_LOGIN_URL"),this.scope=this.getEnvironmentVariable("SF_SCOPE"),this.ACCESS_TOKEN_KEY="sf_access_token",this.REFRESH_TOKEN_KEY="sf_refresh_token",this.INSTANCE_URL_KEY="sf_instance_url",this.USER_ID_KEY="sf_user_id",console.log("Client ID:",this.clientId),console.log("Client Secret:",this.clientSecret),console.log("Redirect URI:",this.redirectUri),console.log("Login URL:",this.loginUrl),console.log("Scope:",this.scope),console.log("OAuthService initialized")}isLoggedIn(){const e=this.getStoredAccessToken(),o=this.getStoredRefreshToken(),t=this.getStoredInstanceUrl();return console.log("Checking login status:",{hasAccessToken:!!e,hasRefreshToken:!!o,hasInstanceUrl:!!t}),!!(e||o)&&!!t}getStoredAccessToken(){return sessionStorage.getItem(this.ACCESS_TOKEN_KEY)||localStorage.getItem(this.ACCESS_TOKEN_KEY)}getStoredRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}getStoredInstanceUrl(){return sessionStorage.getItem(this.INSTANCE_URL_KEY)||localStorage.getItem(this.INSTANCE_URL_KEY)}async startOAuthFlow(){try{console.log("Starting OAuth flow...");const e=await this.buildAuthorizationUrl();if(console.log("OAuth URL:",e),window.Capacitor){console.log("Capacitor detected, attempting to open browser...");try{const{Browser:o}=await u("@capacitor/browser/v/7_0_2");console.log("Using Capacitor Browser plugin"),await o.open({url:e,windowName:"_blank",toolbarColor:"#667eea",presentationStyle:"fullscreen"}),console.log("Browser opened successfully with Capacitor plugin")}catch(o){console.log("Capacitor Browser not available, trying alternative methods..."),console.error("Browser plugin error:",o),window.open?(console.log("Trying window.open with _blank target"),window.open(e,"_blank","location=yes,toolbar=yes")||(console.log("Popup blocked, trying _system target"),window.open(e,"_system"))):(console.log("window.open not available, using location.href"),window.location.href=e)}}else console.log("Not in Capacitor, using direct redirect"),window.location.href=e}catch(e){throw console.error("Error starting OAuth flow:",e),new Error("Failed to start OAuth authorization: "+e.message)}}async buildAuthorizationUrl(){const e=this.generateState();console.log("Generated OAuth state:",e);const o=this.generateCodeVerifier(),t=await this.generateCodeChallenge(o);sessionStorage.setItem("oauth_code_verifier",o);const n=new URLSearchParams({response_type:"code",client_id:this.clientId,redirect_uri:this.redirectUri,scope:this.scope,state:e,code_challenge:t,code_challenge_method:"S256",display:"touch",prompt:"login"}),r=`${this.loginUrl}/services/oauth2/authorize?${n.toString()}`;return console.log("=== SALESFORCE OAUTH CONFIGURATION ==="),console.log("Login URL:",this.loginUrl),console.log("Client ID:",this.clientId),console.log("Redirect URI:",this.redirectUri),console.log("Scope:",this.scope),console.log("State:",e),console.log("Code Challenge:",t),console.log("Full Authorization URL:",r),console.log("========================================="),r}generateCodeVerifier(){const e=new Uint8Array(32);return window.crypto.getRandomValues(e),this.base64URLEncode(e)}async generateCodeChallenge(e){const t=new TextEncoder().encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return this.base64URLEncode(new Uint8Array(n))}base64URLEncode(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async handleOAuthCallback(e,o){try{console.log("Handling OAuth callback:",{authorizationCode:e,state:o});const t=sessionStorage.getItem("oauth_state");if(console.log("Stored state:",t,"Received state:",o),o!==t)throw new Error("Invalid state parameter - possible CSRF attack");console.log("Exchanging code for tokens...");const n=await this.exchangeCodeForTokens(e);console.log("Token exchange successful:",{hasAccessToken:!!n.access_token,hasRefreshToken:!!n.refresh_token,instanceUrl:n.instance_url}),this.storeTokens(n);const r=await this.initializeConnection();return{success:!0,connection:r,userInfo:n}}catch(t){throw console.error("OAuth callback error:",t),t}finally{sessionStorage.removeItem("oauth_state")}}async exchangeCodeForTokens(e){const o=`${this.loginUrl}/services/oauth2/token`,t=sessionStorage.getItem("oauth_code_verifier"),n={grant_type:"authorization_code",client_id:this.clientId,client_secret:this.clientSecret,redirect_uri:this.redirectUri,code:e,code_verifier:t},r={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams(n)};console.log("Making token exchange request to:",o),console.log("Token request data:",{grant_type:n.grant_type,client_id:n.client_id,redirect_uri:n.redirect_uri,code:e?"present":"missing",code_verifier:t?"present":"missing"});try{const c=await fetch(o,r);if(console.log("Token response status:",c.status),!c.ok){const a=await c.text();throw console.error("Token exchange failed on primary host:",a),new Error(a||"Primary token exchange failed")}return sessionStorage.removeItem("oauth_code_verifier"),c.json()}catch(c){if(this.loginUrl.includes(".my.site.com")){const s=`${this.loginUrl.replace(".my.site.com",".my.salesforce.com")}/services/oauth2/token`;console.log("Retrying token exchange via My Domain host:",s);try{const i=await fetch(s,r);if(console.log("Fallback token response status:",i.status),!i.ok){const l=await i.text();throw console.error("Fallback token exchange failed:",l),new Error(l||"Fallback token exchange failed")}return sessionStorage.removeItem("oauth_code_verifier"),i.json()}catch(i){throw console.error("Token exchange failed after fallback:",i),new Error(`Token exchange failed on both hosts: ${i.message||i}`)}}throw new Error(c.message||"Token exchange failed")}}storeTokens(e){if(console.log("\u{1F510} Storing tokens..."),console.log("\u{1F510} Token response structure:",{has_access_token:!!e.access_token,has_refresh_token:!!e.refresh_token,has_instance_url:!!e.instance_url,has_id:!!e.id}),sessionStorage.setItem(this.ACCESS_TOKEN_KEY,e.access_token),sessionStorage.setItem(this.INSTANCE_URL_KEY,e.instance_url),e.refresh_token?(localStorage.setItem(this.REFRESH_TOKEN_KEY,e.refresh_token),console.log("\u{1F510} Refresh token stored in localStorage")):console.warn("\u26A0\uFE0F No refresh token in response - this might cause issues on app restart"),localStorage.setItem(this.INSTANCE_URL_KEY,e.instance_url),e.id){const o=e.id.match(/\/([a-zA-Z0-9]{15,18})$/);if(o){const t=o[1];sessionStorage.setItem(this.USER_ID_KEY,t),localStorage.setItem(this.USER_ID_KEY,t),console.log("\u{1F510} Stored user ID:",t)}}console.log("\u2705 Tokens stored successfully")}async initializeConnection(){console.log("Initializing JSForce connection...");const e=this.getStoredAccessToken(),o=this.getStoredRefreshToken(),t=this.getStoredInstanceUrl();if(!t)throw new Error("No instance URL found");const n=window.jsforce;if(!n)throw new Error("JSForce library not loaded");const r=new n.Connection({oauth2:{clientId:this.clientId,clientSecret:this.clientSecret,redirectUri:this.redirectUri},instanceUrl:t,accessToken:e,refreshToken:o,version:"60.0"});return r.on("refresh",c=>{console.log("Access token refreshed automatically"),sessionStorage.setItem(this.ACCESS_TOKEN_KEY,c)}),!e&&o&&(console.log("No access token, refreshing using refresh token..."),await this.refreshAccessToken(r)),console.log("JSForce connection initialized successfully"),r}async refreshAccessToken(e=null){try{console.log("\u{1F504} Refreshing access token...");const o=this.getStoredRefreshToken(),t=this.getStoredInstanceUrl();if(!o)throw new Error("No refresh token available");if(!t)throw new Error("No instance URL available");console.log("\u{1F504} Using refresh token to get new access token..."),console.log("\u{1F504} Instance URL:",t);const n=`${t}/services/oauth2/token`,r={grant_type:"refresh_token",refresh_token:o,client_id:this.clientId};this.clientSecret?(r.client_secret=this.clientSecret,console.log("\u{1F504} Using client secret for token refresh")):console.log("\u{1F504} No client secret - using public client flow");const c=new URLSearchParams(r),a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:c.toString()});if(!a.ok){const i=await a.text();throw console.error("\u{1F504} Token refresh HTTP error:",a.status,i),new Error(`Token refresh failed: ${a.status} ${i}`)}const s=await a.json();return console.log("\u{1F504} Token refresh successful:",{access_token:s.access_token?"present":"missing",instance_url:s.instance_url||"not returned",refresh_token:s.refresh_token?"new refresh token received":"no new refresh token"}),sessionStorage.setItem(this.ACCESS_TOKEN_KEY,s.access_token),s.instance_url&&(sessionStorage.setItem(this.INSTANCE_URL_KEY,s.instance_url),localStorage.setItem(this.INSTANCE_URL_KEY,s.instance_url)),s.refresh_token&&(localStorage.setItem(this.REFRESH_TOKEN_KEY,s.refresh_token),console.log("\u{1F504} New refresh token stored")),console.log("\u2705 Access token refreshed successfully"),s.access_token}catch(o){if(console.error("\u274C Token refresh failed:",o),o.message&&o.message.includes("400"))try{const t=o.message;if(console.error("\u{1F504} Detailed error:",t),t.includes("invalid_grant"))throw console.log("\u{1F504} Invalid grant error - refresh token might be revoked or expired"),this.clearTokens(),document.dispatchEvent(new CustomEvent("auth-logout",{detail:{reason:"refresh_token_expired",error:t}})),new Error("Your session has expired. Please log in again.")}catch(t){console.warn("Could not parse error details:",t)}throw o.message.includes("invalid_grant")||o.message.includes("expired")||o.message.includes("invalid_client")?(console.log("\u{1F504} Authentication error detected, clearing tokens"),this.clearTokens(),document.dispatchEvent(new CustomEvent("auth-logout",{detail:{reason:"auth_error",error:o.message}})),new Error("Session expired. Please log in again.")):new Error(`Token refresh failed: ${o.message}`)}}async getValidConnection(){try{if(console.log("Getting valid connection..."),!this.isLoggedIn())throw new Error("User not logged in");const e=await this.initializeConnection();return console.log("JSForce connection initialized, returning to AuthUtils for testing"),e}catch(e){throw console.error("Failed to get valid connection:",e),e}}clearTokens(){console.log("Clearing all tokens..."),sessionStorage.removeItem(this.ACCESS_TOKEN_KEY),sessionStorage.removeItem(this.INSTANCE_URL_KEY),sessionStorage.removeItem(this.USER_ID_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY),localStorage.removeItem(this.INSTANCE_URL_KEY),localStorage.removeItem(this.USER_ID_KEY),console.log("All tokens cleared")}getEnvironmentVariable(e){if(window.Capacitor)try{if(window.Capacitor.getPlatform()==="android")try{if(window.AndroidConfig&&typeof window.AndroidConfig.getConfigValue=="function"){const t=window.AndroidConfig.getConfigValue(e);if(t)return t}}catch(t){console.error("Error accessing Android config:",t)}}catch(o){console.error("Error accessing environment variable:",o)}return console.error(`Environment variable ${e} not found`),null}generateState(){const e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return sessionStorage.setItem("oauth_state",e),e}async logout(){try{console.log("Logging out user...");const e=this.getStoredAccessToken();if(e){const o=`${this.getStoredInstanceUrl()}/services/oauth2/revoke`;await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`token=${e}`}),console.log("Tokens revoked on server")}}catch(e){console.error("Error revoking token:",e)}finally{this.clearTokens(),console.log("Logout completed")}}}const w=h(m,{tmpl:f,sel:"c-oauth-service",apiVersion:63});class g{constructor(){this.oauthService=new w,this._connectionPromise=null,this._lastConnectionTime=0,this._connectionCacheDuration=2*60*1e3}async getValidConnection(){const e=Date.now();if(this._connectionPromise&&e-this._lastConnectionTime<this._connectionCacheDuration)try{return await this._connectionPromise}catch(o){console.warn("Cached connection expired, creating new one:",o.message)}return this._connectionPromise=this._createValidConnection(),this._lastConnectionTime=e,this._connectionPromise}async _createValidConnection(){try{if(console.log("\u{1F510} AuthUtils: Creating valid connection..."),!this.hasAnyTokens())throw new Error("No authentication tokens found. Please login first.");const e=await this.oauthService.getValidConnection();try{return await e.query("SELECT Id FROM User LIMIT 1"),console.log("\u2705 AuthUtils: Connection test successful"),e}catch(o){if(console.warn("\u26A0\uFE0F AuthUtils: Connection test failed, attempting refresh...",o.message),o.errorCode==="INVALID_SESSION_ID"||o.message.includes("Session expired")||o.message.includes("expired access/refresh token")){console.log("\u{1F504} AuthUtils: Attempting token refresh due to session error"),this._connectionPromise=null,await this.oauthService.refreshAccessToken();const t=await this.oauthService.getValidConnection();return await t.query("SELECT Id FROM User LIMIT 1"),console.log("\u2705 AuthUtils: New connection after refresh successful"),t}throw o}}catch(e){throw console.error("\u274C AuthUtils: Failed to create valid connection:",e),this.isTokenExpiredError(e)?(console.log("\u{1F504} AuthUtils: Tokens expired, clearing stored tokens"),this.oauthService.clearTokens(),this.dispatchLogoutEvent(),new Error("Session expired. Please log in again.")):e}}hasAnyTokens(){const e=sessionStorage.getItem("sf_access_token")||localStorage.getItem("sf_access_token"),o=localStorage.getItem("sf_refresh_token"),t=sessionStorage.getItem("sf_instance_url")||localStorage.getItem("sf_instance_url");return!!(e||o)&&!!t}isTokenExpiredError(e){const o=e.message?.toLowerCase()||"",t=e.errorCode?.toLowerCase()||"";return o.includes("invalid_grant")||o.includes("expired")||o.includes("session expired")||t==="invalid_session_id"||t==="invalid_grant"}dispatchLogoutEvent(){try{const e=new CustomEvent("auth-logout",{bubbles:!0,composed:!0,detail:{reason:"token_expired"}});typeof document!="undefined"&&document.dispatchEvent(e)}catch(e){console.warn("Failed to dispatch logout event:",e)}}async ensureAuthenticated(){try{return await this.getValidConnection(),!0}catch(e){return console.error("Authentication check failed:",e),!1}}async getConnectionForComponent(){try{return await this.getValidConnection()}catch(e){throw new Error(`Not authenticated. ${e.message}`)}}clearConnectionCache(){this._connectionPromise=null,this._lastConnectionTime=0,console.log("\u{1F504} AuthUtils: Connection cache cleared")}forceLogout(){console.log("\u{1F510} AuthUtils: Force logout - clearing all caches and tokens"),this.clearConnectionCache(),this.oauthService.clearTokens()}isLoggedIn(){return this.oauthService.isLoggedIn()}getTokenInfo(){return{hasAccessToken:!!sessionStorage.getItem("sf_access_token"),hasRefreshToken:!!localStorage.getItem("sf_refresh_token"),hasInstanceUrl:!!sessionStorage.getItem("sf_instance_url"),instanceUrl:sessionStorage.getItem("sf_instance_url")}}}const S=new g,k=h(S,{tmpl:_,sel:"c-auth-utils",apiVersion:63});export{g as AuthUtils,k as default};
